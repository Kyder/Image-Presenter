<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Signage Display</title>
    <link rel="stylesheet" href="mainapp.css">
</head>
<body>
    <div id="main-container">
        <div id="media-container">
            <div id="loading">Loading media...</div>
            <div id="no-media">
                <h2>No Media Files Found</h2>
                <p>Please add media files to the Media folder</p>
                <p>Supported formats: SVG, PNG, JPG, MP4</p>
            </div>
        </div>
        
        <div id="addon-container"></div>
        
    </div>
    
    <script src="image-scaling.js"></script>
    
    <script>
        let mediaFiles = [];
        let currentIndex = 0;
        let config = {
            imageDuration: 5000,
            videoPosition: 'after',
            imageScaling: 'contain',
            rotation: 0
        };
        let isPlaying = false;
        let currentTimeout = null;
        let loadedAddons = new Map();
        
        let preloadedImages = new Map();
        let preloadQueue = [];
        let isPreloading = false;
        
        async function init() {
            try {
                await loadConfig();
                console.log('App initialized with config:', config);
                
                window.imageScaler.setScalingMode(config.imageScaling);
                
                await loadMedia();
                setupEventListeners();
                applyRotation();
                await loadFrontendAddons();
                
                if (mediaFiles.length > 0) {
                    startPlayback();
                }
            } catch (err) {
                console.error('Init error:', err);
            }
        }
        
        function applyRotation() {
            const container = document.getElementById('main-container');
            container.style.transform = `rotate(${config.rotation}deg)`;
            
            if (Math.abs(config.rotation) === 90 || Math.abs(config.rotation) === 270) {
                container.style.width = '100vh';
                container.style.height = '100vw';
            } else {
                container.style.width = '100%';
                container.style.height = '100%';
            }
        }
        
        async function loadFrontendAddons() {
            try {
                const addons = await window.electronAPI.getAddons();
                
                for (const [id, addon] of loadedAddons) {
                    if (addon.cleanup) {
                        addon.cleanup();
                    }
                }
                loadedAddons.clear();
                
                const addonContainer = document.getElementById('addon-container');
                addonContainer.innerHTML = '';
                
                for (const [id, addonConfig] of Object.entries(addons)) {
                    if (!addonConfig.enabled) continue;
                    
                    try {
                        const script = await getAddonFrontendScript(id, addonConfig);
                        
                        if (script) {
                            const scriptElement = document.createElement('script');
                            scriptElement.textContent = script;
                            document.head.appendChild(scriptElement);
                            
                            loadedAddons.set(id, {
                                info: addonConfig.info,
                                config: addonConfig.config,
                                script: scriptElement,
                                cleanup: () => {
                                    if (scriptElement.parentNode) {
                                        scriptElement.parentNode.removeChild(scriptElement);
                                    }
                                    if (window[`${id}Addon`] && window[`${id}Addon`].cleanup) {
                                        window[`${id}Addon`].cleanup();
                                    }
                                }
                            });
                            
                            console.log(`Loaded frontend addon: ${addonConfig.info.name}`);
                        }
                        
                    } catch (err) {
                        console.error(`Failed to load frontend addon ${id}:`, err);
                    }
                }
                
            } catch (err) {
                console.error('Failed to load frontend addons:', err);
            }
        }
        
        async function getAddonFrontendScript(addonId, addonConfig) {
            try {
                if (window.electronAPI && window.electronAPI.getAddonFrontendScript) {
                    return await window.electronAPI.getAddonFrontendScript(addonId, addonConfig);
                } else {
                    console.warn(`Cannot get frontend script for addon ${addonId}: electronAPI not available`);
                    return null;
                }
            } catch (err) {
                console.error(`Failed to get frontend script for addon ${addonId}:`, err);
                return null;
            }
        }
        
        async function loadConfig() {
            try {
                config = await window.electronAPI.getConfig();
                console.log('Loaded config:', config);
            } catch (err) {
                console.error('Failed to load config:', err);
            }
        }
        
        async function loadMedia() {
            try {
                mediaFiles = await window.electronAPI.getMediaFiles();
                
                if (config.videoPosition === 'after') {
                    mediaFiles.sort((a, b) => {
                        if (a.type === 'image' && b.type === 'video') return -1;
                        if (a.type === 'video' && b.type === 'image') return 1;
                        return a.name.localeCompare(b.name);
                    });
                } else {
                    mediaFiles.sort((a, b) => a.name.localeCompare(b.name));
                }
                
                document.getElementById('loading').style.display = 'none';
                
                if (mediaFiles.length === 0) {
                    document.getElementById('no-media').style.display = 'block';
                } else {
                    document.getElementById('no-media').style.display = 'none';
                    startImagePreloading();
                }
            } catch (err) {
                console.error('Failed to load media:', err);
                document.getElementById('loading').textContent = 'Error loading media';
            }
        }
        
        function startImagePreloading() {
            const imageFiles = mediaFiles.filter(file => file.type === 'image');
            
            for (let i = 0; i < Math.min(3, imageFiles.length); i++) {
                preloadImage(imageFiles[i]);
            }
            
            for (let i = 3; i < imageFiles.length; i++) {
                preloadQueue.push(imageFiles[i]);
            }
            
            if (preloadQueue.length > 0 && !isPreloading) {
                continuePreloading();
            }
        }
        
        function preloadImage(file) {
            if (preloadedImages.has(file.path)) return;
            
            const img = new Image();
            img.onload = () => {
                preloadedImages.set(file.path, img);
                console.log(`Preloaded: ${file.name}`);
            };
            img.onerror = () => {
                console.warn(`Failed to preload: ${file.name}`);
            };
            img.src = `file://${file.path}`;
        }
        
        function continuePreloading() {
            if (preloadQueue.length === 0 || isPreloading) return;
            
            isPreloading = true;
            const file = preloadQueue.shift();
            
            const img = new Image();
            img.onload = () => {
                preloadedImages.set(file.path, img);
                console.log(`Background preloaded: ${file.name}`);
                isPreloading = false;
                setTimeout(continuePreloading, 100);
            };
            img.onerror = () => {
                console.warn(`Failed to background preload: ${file.name}`);
                isPreloading = false;
                setTimeout(continuePreloading, 100);
            };
            img.src = `file://${file.path}`;
        }
        
        function setupEventListeners() {
            window.electronAPI.onConfigUpdate(async (newConfig) => {
                console.log('Config update received');
                
                const oldScalingMode = config.imageScaling;
                const newScalingMode = newConfig.imageScaling;
                
                config = newConfig;
                
                if (oldScalingMode !== newScalingMode) {
                    console.log(`Image scaling changed: ${oldScalingMode} to ${newScalingMode}`);
                    window.imageScaler.setScalingMode(newScalingMode);
                    window.imageScaler.updateActiveMedia();
                }
                
                applyRotation();
                await loadFrontendAddons();
                
                if (isPlaying && mediaFiles[currentIndex]?.type === 'image') {
                    clearTimeout(currentTimeout);
                    currentTimeout = setTimeout(nextMedia, config.imageDuration);
                }
            });
            
            window.electronAPI.onMediaUpdate(async () => {
                await loadMedia();
                if (!isPlaying && mediaFiles.length > 0) {
                    startPlayback();
                }
            });
            
            window.electronAPI.onAddonsUpdate(async () => {
                console.log('Addons updated, reloading...');
                await loadFrontendAddons();
            });
        }
        
        function startPlayback() {
            if (mediaFiles.length === 0) return;
            
            isPlaying = true;
            currentIndex = 0;
            showMedia(currentIndex);
        }
        
        // FIXED showMedia function - prevents image layering issues
        function showMedia(index) {
            const container = document.getElementById('media-container');
            const file = mediaFiles[index];
            
            console.log(`\n=== SHOWING MEDIA ${index} ===`);
            console.log(`File: ${file.name}`);
            console.log(`Type: ${file.type}`);
            
            // IMMEDIATE CLEANUP: Remove all old elements before showing new one
            const oldElements = container.querySelectorAll('.media-item');
            oldElements.forEach(el => {
                el.style.transition = 'none';
                el.remove();
            });
            
            // Create new media element
            let newElement;
            
            if (file.type === 'image') {
                newElement = document.createElement('img');
                newElement.className = 'media-item';
                
                // Set high z-index and ensure it covers everything
                newElement.style.cssText = `
                    position: absolute;
                    opacity: 0;
                    transition: opacity 0.5s ease-in-out;
                    z-index: 100;
                    transform: translateZ(0);
                    backface-visibility: hidden;
                    will-change: opacity;
                    image-rendering: auto;
                    contain: layout style paint;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: #000;
                `;
                
                const preloadedImg = preloadedImages.get(file.path);
                
                if (preloadedImg) {
                    console.log(`Using preloaded image: ${file.name}`);
                    newElement.src = preloadedImg.src;
                    
                    // Add to container immediately
                    container.appendChild(newElement);
                    
                    // Force layout calculation
                    newElement.offsetHeight;
                    
                    // Apply scaling before making visible
                    window.imageScaler.applyScaling(newElement);
                    
                    // Make visible with smooth transition
                    requestAnimationFrame(() => {
                        newElement.classList.add('active');
                        newElement.style.opacity = '1';
                        console.log(`Image activated: ${file.name}`);
                    });
                    
                    // Set timeout for next image
                    currentTimeout = setTimeout(nextMedia, config.imageDuration);
                    
                } else {
                    console.log(`Loading image normally: ${file.name}`);
                    
                    newElement.onload = () => {
                        console.log(`Image loaded: ${file.name}`);
                        
                        // Add to container
                        container.appendChild(newElement);
                        newElement.offsetHeight;
                        
                        // Apply scaling before making visible
                        window.imageScaler.applyScaling(newElement);
                        
                        // Make visible
                        requestAnimationFrame(() => {
                            newElement.classList.add('active');
                            newElement.style.opacity = '1';
                        });
                        
                        currentTimeout = setTimeout(nextMedia, config.imageDuration);
                    };
                    
                    newElement.onerror = () => {
                        console.error('Failed to load image:', file.name);
                        nextMedia();
                    };
                    
                    newElement.src = `file://${file.path}`;
                }
                
            } else if (file.type === 'video') {
                newElement = document.createElement('video');
                newElement.className = 'media-item';
                newElement.src = `file://${file.path}`;
                newElement.autoplay = true;
                newElement.muted = true;
                
                // Ensure video covers everything
                newElement.style.cssText = `
                    position: absolute;
                    opacity: 0;
                    transition: opacity 0.5s ease-in-out;
                    z-index: 100;
                    transform: translateZ(0);
                    backface-visibility: hidden;
                    will-change: opacity;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: #000;
                `;
                
                console.log('Created video element, waiting for load...');
                
                // Apply scaling to video
                window.imageScaler.applyScaling(newElement);
                
                newElement.onloadeddata = () => {
                    console.log(`Video loaded: ${file.name}`);
                    
                    container.appendChild(newElement);
                    newElement.offsetHeight;
                    
                    requestAnimationFrame(() => {
                        newElement.classList.add('active');
                        newElement.style.opacity = '1';
                    });
                };
                
                newElement.onended = () => {
                    nextMedia();
                };
                
                newElement.onerror = () => {
                    console.error('Failed to load video:', file.name);
                    nextMedia();
                };
            }
            
            // Preload next image in background
            const nextIndex = (index + 1) % mediaFiles.length;
            const nextFile = mediaFiles[nextIndex];
            if (nextFile && nextFile.type === 'image' && !preloadedImages.has(nextFile.path)) {
                preloadImage(nextFile);
            }
        }
        
        function nextMedia() {
            currentIndex = (currentIndex + 1) % mediaFiles.length;
            showMedia(currentIndex);
        }
        
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>